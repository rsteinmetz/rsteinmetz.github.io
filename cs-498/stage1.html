<div>
    <div class="slideIntroText">
        Using the slider below, we can adjust the year and see the number of vehicles produced each year along with the fuel types they consume.
    </div>
    <span id="dateRangeText">1984</span>
    <input type="range" min="1984" max="2020" value="1984" class="slider" id="dateRange"/>
    <div id="annotation"></div>
    <div id="legend"></div>
    <div id="tooltip"></div>
    <div id="scene1"></div>
    <script>
        $(document).ready(function() {

        // initailize screen data
        var margin = {
            top: 30,
            right: 30,
            bottom: 70,
            left: 60
        }
        var width = 1600 - margin.left - margin.right
        var height = 900 - margin.top - margin.bottom 
        var data = []
        var filteredData = []
        var sceneInterval = null
        var dateSlider = document.getElementById("dateRange")
        var dateRangeText = document.getElementById("dateRangeText")
        var annotation = d3.select("#annotation").attr("pointer-events", "none")
        var tooltip = d3.select("#tooltip").attr("pointer-events", "none")

        dateSlider.oninput = function() {
            var newDate = this.value
            dateRangeText.innerHTML = newDate
            filteredData = _.uniqBy(_.filter(data, function(o) { return o.year.toString() == `${newDate.toString()}`; }), "model");
            updateChart()
        }

        // initialize svg canvas
        var svg = d3
            .select("#scene1")
            .append("svg")
            .attr("id", "graph")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        updateChart = function() {

            svg.exit().remove()
            d3.select("g").selectAll("*").remove()

            var fuelTypeCount = []
            var legendObject = []
            var unique = [...new Set(filteredData.map(item => item.fuelType1))];
            for(var i = 0; i < unique.length; i++) {
                var count = 0
                for(var n = 0; n < filteredData.length; n++) {
                    if (unique[i] == filteredData[n].fuelType1) {
                        count = count + 1
                    }
                }
                fuelTypeCount.push({ type: unique[i], count: count })
                legendObject.push({ type: unique[i], count: count })
            }
            graphData = fuelTypeCount.sort((function(a,b) { return b.count > a.count ? 1 : -1}))
            temp = fuelTypeCount.slice()
            legendObject = temp.sort((a,b) => (a.type > b.type) ? 1 : ((b.type > a.type) ? -1 : 0)); 

            // create legend
            var uniqueAll = [...new Set(data.map(item => item.fuelType1))];
            var color = d3.scaleOrdinal()
            .domain(uniqueAll)
            .range(d3.schemeTableau10)

            if (dateRangeText.innerHTML == 1984) {
                annotation
                    .style("opacity", 1)
                    .html(`In 1984, we can see that Regular Gasoline and Diesel were the only two fuels being used in cars.`)

                    svg.append("svg:defs").append("svg:marker")
                        .attr("id", "triangle")
                        .attr("refX", 100)
                        .attr("refY", 100)
                        .attr("markerWidth", 300)
                        .attr("markerHeight", 300)
                        .attr("orient", "auto")
                        .append("path")
                        .attr("d", "M 0 0 12 6 0 12 3 6")
                        .style("fill", "black");


            } else if (dateRangeText.innerHTML == 1985) {
                annotation
                    .style("opacity", 1)
                    .html(`In 1985, we see vehicles with premium gasoline being made.`)
            } else if (dateRangeText.innerHTML == 1986) {
                annotation
                    .style("opacity", 1)
                    .html(`In 1986, we see that premium gasoline cars start being produced more than diesel.`)
            } else if (dateRangeText.innerHTML == 1998) {
                annotation
                    .style("opacity", 1)
                    .html(`In 1998, we see the first electric vehicle hit the market.`)
            } else if (dateRangeText.innerHTML == 2013) {
                annotation
                    .style("opacity", 1)
                    .html(`In 2013, there were more electric vehicles hitting the market than diesel vehicles. We can also see that Premium Gasoline cars are being produced more than Regular. This indicates that there is some desire in the marketplace for fuel efficency.`)
            } else if (dateRangeText.innerHTML == 2020) {
                annotation
                    .style("opacity", 1)
                    .html(`Today we can see that electric cars are becoming more and more popular. Let's investigate why in the next slide.`)
            } else {
                annotation.style("opacity", 0)
            }

            // create x axis
            var x = 
                d3
                    .scaleBand()
                    .range([0, width])
                    .domain(fuelTypeCount.map(function(d) { return d.type }))
                    .padding(0.2)

                // add x axis
                svg.append("g")
                    .attr("transform", "translate(0, " + height + ")")
                    .call(d3.axisBottom(x))
                    .selectAll("text")
                    .attr("transform", "translate(-10,0)rotate(-45)")
                    .style("text-anchor", "end")

                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Number of Vehicles");

                //let's figure out the max value for the y axis
                var maxY = 0;
                for (var i = 0; i < unique.length; i++) {
                    if (graphData[i].count > maxY) {
                        maxY = graphData[i].count
                    }
                }

                // create y axis
                var y = d3.scaleLinear()
                    .domain([0, 550])
                    .range([height, 0]);

                // add y axis
                svg.append("g").call(d3.axisLeft(y))

                // create bars
                svg.selectAll("rect")
                .data(graphData)
                .enter()
                .append("rect")
                .attr("x", function(d) { return x(d.type)})
                .attr("y", function(d) { return y(d.count)})
                .attr("width", x.bandwidth())
                .attr("height", function(d) { return height - y(d.count)})
                .attr("fill", function(d) { return color(d.type) })
                .on("mouseover", function(d,i) {
                    console.log("mouseover")
                    tooltip
                    .style("opacity", 1)
                    .style("left", (d3.event.pageX)+"px")
                    .style("top", (d3.event.pageY)+"px")
                    .html(`Type: ${d.type}<br/>Count: ${d.count}`)
                })
                .on("mouseout", function(d,i) {
                    tooltip
                    .style("opacity", 0)
                })

            var size = 20
            svg
            .selectAll("mydots")
            .data(legendObject)
            .enter()
            .append("rect")
            .attr("x", 1200 + size*1.2)
            .attr("y", function(d,i){ return 400+(i*(size+5))}) // 100 is where the first dot appears. 25 is the distance between dots
            .attr("width", size)
            .attr("height", size)
            .style("fill", function(d) { return color(d.type) })
 
            svg
            .selectAll("mylabels")
            .data(legendObject)
            .enter()
            .append("text")
            .attr("x", 1225 + size)
            .attr("y", function(d, i) { return 400+(i*(size+5) + (size/2))})
            .style("fill", function(d) { return color(d.type) })
            .text(function(d) { return d.type})
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
        }

        // grab dataset
        d3
            .csv("https://raw.githubusercontent.com/rsteinmetz/rsteinmetz.github.io/master/cs-498/data/vehicles.csv")
            .then((d) => {
                data = _.filter(d, function(o) { return o.make != "BYD"});
                filteredData = _.uniqBy(_.filter(data, function(o) { return o.year == "1984"; }), "model");
                updateChart()
            })
        
        })
    </script>
</div>