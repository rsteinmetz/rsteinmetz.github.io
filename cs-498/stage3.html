<div>
    <p>Fill out the options below to see how much money you could save per year on fuel.</p>
    <p>The default values are the national averages.</p>
    <p>
        <input id="mpg" class="parameter" type="number" value="32">
        Enter how many Miles Per Gallon (MPG) your current vehicle gets.
    </p>
    <p>
        <input id="gasCost" class="parameter" type="number" value="2.84">
        Enter the price of gasoline in your area.
    </p>
    <p>
        <input id="miles" class="parameter" type="number" value="400"/>
        Enter how many miles you drive per month.
    </p>
    <p>
        <input id="kwh" class="parameter" type="number" value="0.12"/>
        Enter how many cents you pay per kWh of electricity.
    </p>
    <p>
        <input id="mpkwh" class="parameter" type="number" value="4"/>
        Enter how many miles your electric vehicle gets per kWh.
    </p>
    <div id="tooltip"></div>
    <div id="scene3"></div>
    <script>
        $(".parameter").change(function(e) {
            updateChart()
        })


        // initailize screen data
        var margin = {
            top: 30,
            right: 30,
            bottom: 70,
            left: 60
        }
        var width = 1600 - margin.left - margin.right
        var height = 900 - margin.top - margin.bottom 
        var tooltip = d3.select("#tooltip").attr("pointer-events", "none")

        var data = {
            series: [
                {
                    name: "Gasoline Cost",
                    values: []
                },
                {
                    name: "Electricity Cost",
                    values: []
                }
            ],
            dates: [Date.parse("2020-01-01"), Date.parse("2020-02-01"), Date.parse("2020-03-01"), Date.parse("2020-04-01"), Date.parse("2020-05-01"),Date.parse("2020-06-01"),Date.parse("2020-07-01"),Date.parse("2020-08-01"),Date.parse("2020-09-01"),Date.parse("2020-10-01"),Date.parse("2020-11-01"),Date.parse("2020-12-01")]
        }

        // initialize svg canvas
        var svg = d3
            .select("#scene3")
            .append("svg")
            .attr("id", "graph")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var updateChart = function() {

            svg.exit().remove()
            d3.select("g").selectAll("*").remove()

            // grab the values to recalculate the data
            var old_car_mpg = $("#mpg").val()
            var old_car_miles = $("#miles").val()
            var averageElectricityCostPerkWh = $("#kwh").val()
            var averageGasolineCost = $("#gasCost").val()
            var milesPerKwh = $("#mpkwh").val()

            var gasolineCostArray = []
            var electricityCostArray = []

            var gasRunningTotal = 0.0
            var electricRunningTotal = 0.0
            
            for (var m = 0; m < 12; m++) {
                var gasAdd = (old_car_miles / old_car_mpg) * averageGasolineCost
                var electricAdd = (old_car_miles / milesPerKwh) * averageElectricityCostPerkWh

                gasRunningTotal += gasAdd
                electricRunningTotal += electricAdd
                
                gasolineCostArray.push(gasRunningTotal)
                electricityCostArray.push(electricRunningTotal)
            }

            data.series = [
                {
                    name: "Gasoline Cost",
                    values: gasolineCostArray 
                },
                {
                    name: "Electricity Cost",
                    values: electricityCostArray
                }
            ]

            var legendObject = ["Gasoline Cost", "Electricity Cost"]
            var color = d3.scaleOrdinal()
                .domain(legendObject)
                .range(d3.schemeTableau10)

            x = d3.scaleUtc()
                .domain(d3.extent(data.dates))
                .range([margin.left, width - margin.right])

            xAxis = g => g
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(width / 80).tickSizeOuter(0))

            svg.append("g")
                .call(xAxis);

            y = d3.scaleLinear()
                .domain([0, d3.max(data.series, d => d3.max(d.values))]).nice()
                .range([height - margin.bottom, margin.top])

            yAxis = g => g
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y))
                .call(g => g.select(".domain").remove())
                .call(g => g.select(".tick:last-of-type text").clone()
                    .attr("x", 3)
                    .attr("text-anchor", "start")
                    .attr("font-weight", "bold")
                    .text(`$${data.y}`))

            svg.append("g")
                .call(yAxis);

            // draw gas line
            var gasLine = _.filter(data.series, function(d) { return d.name == "Gasoline Cost" })
            line1 = d3.line()
                .defined(d => !isNaN(d))
                .x((d, i) => x(data.dates[i]))
                .y(d => y(d))
                    const path1 = svg.append("g")
                        .attr("fill", "none")
                        .attr("stroke", "rgb(78, 121, 167)")
                        .attr("stroke-width", 5)
                        .attr("stroke-linejoin", "round")
                        .attr("stroke-linecap", "round")
                        .selectAll("path")
                        .data(gasLine)
                        .join("path")
                        .style("mix-blend-mode", "multiply")
                        .attr("d", d => line1(d.values))
                        .on("mouseout", function(d,i) {
                            tooltip
                            .style("opacity", 0)
                        })

                //add points to the graph...
                for (var i = 0; i < gasLine.length; i++) {
                    svg.selectAll("points")
                        .data(gasLine[i].values)
                        .enter()
                        .append("circle")
                        .on("mouseover", function(d,i) {
                            console.log(d)
                            tooltip
                            .style("opacity", 1)
                            .style("left", (d3.event.pageX)+"px")
                            .style("top", (d3.event.pageY)+"px")
                            .html(`Gas Cost: $${d.toFixed(2)}`)
                        })
                        .attr("fill", "rgb(78, 121, 167)")
                        .attr("stroke", "none")
                        .attr("cx", function(d,i) { return x(data.dates[i]) })
                        .attr("cy", function(d) { return y(d) })
                        .attr("r", 10)

                }

            // draw electricity line
            var electricityLine = _.filter(data.series, function(d) { return d.name == "Electricity Cost" })
            line2 = d3.line()
                .defined(d => !isNaN(d))
                .x((d, i) => x(data.dates[i]))
                .y(d => y(d))
                    const path2 = svg.append("g")
                        .attr("fill", "none")
                        .attr("stroke", "rgb(225, 87, 89)")
                        .attr("stroke-width", 5)
                        .attr("stroke-linejoin", "round")
                        .attr("stroke-linecap", "round")
                        .selectAll("path")
                        .data(electricityLine)
                        .join("path")
                        .style("mix-blend-mode", "multiply")
                        .attr("d", d => line2(d.values))
                        .on("mouseout", function(d,i) {
                            tooltip
                            .style("opacity", 0)
                        })

                //add points to the graph...
                for (var i = 0; i < electricityLine.length; i++) {
                    svg.selectAll("points")
                        .data(electricityLine[i].values)
                        .enter()
                        .append("circle")
                        .on("mouseover", function(d,i) {
                            console.log(d)
                            tooltip
                            .style("opacity", 1)
                            .style("left", (d3.event.pageX)+"px")
                            .style("top", (d3.event.pageY)+"px")
                            .html(`Electricity Cost: $${d.toFixed(2)}`)
                        })
                        .attr("fill", "rgb(225, 87, 89)")
                        .attr("stroke", "none")
                        .attr("cx", function(d,i) { return x(data.dates[i]) })
                        .attr("cy", function(d) { return y(d) })
                        .attr("r", 10)

                }



            // text label for the y axis
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Cost");  


                // legend
                var size = 20
                svg
                .selectAll("mydots")
                .data(legendObject)
                .enter()
                .append("rect")
                .attr("x", 200 + size*1.2)
                .attr("y", function(d,i){ return 200+(i*(size+5))}) // 100 is where the first dot appears. 25 is the distance between dots
                .attr("width", size)
                .attr("height", size)
                .style("fill", function(d) { return d == "Gasoline Cost" ? "rgb(78, 121, 167)": "rgb(225, 87, 89)" })
    
                svg
                .selectAll("mylabels")
                .data(legendObject)
                .enter()
                .append("text")
                .attr("x", 225 + size)
                .attr("y", function(d, i) { return 200+(i*(size+5) + (size/2))})
                .style("fill", function(d) { return d == "Gasoline Cost" ? "rgb(78, 121, 167)": "rgb(225, 87, 89)" })
                .text(function(d) { return d})
                .attr("text-anchor", "left")
                .style("alignment-baseline", "middle")
        }

        updateChart()

    </script>
</div>